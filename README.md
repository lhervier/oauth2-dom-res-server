**[Table of Contents](http://tableofcontent.eu)**
<!-- Table of contents generated generated by http://tableofcontent.eu -->
- [Prepare Domino Server](#prepare-domino-server)
  - [Deploy the dom-spring plugins on your Domino Server](#deploy-the-dom-spring-plugins-on-your-domino-server)
  - [Deploy the oauth2-dom-res-server plugins on your Domino Server](#deploy-the-oauth2-dom-res-server-plugins-on-your-domino-server)
- [Prepare your IDE](#prepare-your-ide)
  - [Domino Designer](#domino-designer)
    - [Install dom-spring update site](#install-dom-spring-update-site)
    - [Install oauth2-dom-res-server update site](#install-oauth2-dom-res-server-update-site)
  - [Eclipse oxygen](#eclipse-oxygen)
    - [Install the XPages SDK](#install-the-xpages-sdk)
    - [Declare Java Runtime and Target Platform](#declare-java-runtime-and-target-platform)
    - [Install the dom-spring plugins](#install-the-dom-spring-plugins)
    - [Install the oauth2-dom-res-server plugins](#install-the-oauth2-dom-res-server-plugins)
- [Create a rest service](#create-a-rest-service)

This project aims at providing a set of Domino OSGI plugins that allows you to write an OAUTH2 resource server. It uses the dom-spring project, allowing you to
write your services as standard Spring Rest controllers.

The Rest Services will have to be protected by an oauth2 access token. The token must be passed in the HTTP header "Authorization", using the "Bearer" schema :

	Authorization: Bearer the_oauth2_access_token

The access token will be interpreted using the oauth2 authorization server introspection endpoint, or - in a near future - by decoding it using a public key (if it is a JWT). 

The details of the token will then be made available to your plugin as a injectable bean named "BearerContext" : This bean will give you access to the name of the logged in user, 
the authorized scopes, and every information made available in the token. But if its "sub" property (the logged in user) correspond to the name of a regular Domino User, 
it will also open a standard NotesSession object for this user.

Note that when implementing servlets as OSGi plugins (this is what dom-spring is doing), you configure an "alias" that will make the servlet available at multiple urls :

- At the root of the server : http://domino_server/your_alias
- At the roor of EVERY nsf : http://domino_server/any_db.nsf/your_alias

When using a context path that reference a nsf database, if the "Authorization" HTTP header is present, Domino will expect it to contain the user login and password.
But in our case, we will send this header with the oauth2 access token in it. For this reason, this framework will make the servlet respond when only called from 
the root of the server.

# Prepare Domino Server

## Deploy the dom-spring plugins on your Domino Server

The (dom-spring)[https://github.com/lhervier/dom-spring] plugins must be deployed into your Domino Server. 
Documentation on how to deploy the plugins is available in the README file of the project on git hub.

## Deploy the oauth2-dom-res-server plugins on your Domino Server

The procedure is almost the same as for the dom-spring plugins.

First, download the latest update site from the github release page of this project, and unzip it where you want.

Then, create a new database named "Oauth2ResUpdateSite.nsf" (you can name it the way you want) on your server, using the "Eclipse Update Site" advanced template.

Open the database with your Notes client, and click on the "Import local update site" button. Go select the "site.xml" in the unzipped version of the update site.

It is recommanded to disable the "sample" feature.

Add (or update) the notes.ini variable "OSGI_HTTP_DYNAMIC_BUNDLES". It must point to your "Oauth2ResUpdateSite.nsf" database. 
Use a comma to separate multiple values if you already have another entry (for dom-spring for example).

Restart the http task (console command):

	restart task http

Check that plugins are deployed : 

	tell http osgi ss oauth.resource
	
You should see something like this :

	> tell http osgi ss oauth
	[1C04:0002-1C08] 28/09/2017 14:27:39   Framework is launched.
	[1C04:0002-1C08] 28/09/2017 14:27:39   id       State       Bundle
	[1C04:0002-1C08] 28/09/2017 14:27:39   95       <<LAZY>>    com.github.lhervier.domino.oauth.resource_1.0.0.qualifier
	[1C04:0002-1C08] 28/09/2017 14:27:39   96       RESOLVED    com.github.lhervier.domino.oauth.resource.external.expiringmap_0.5.8

## Configure the awaited properties

As every dom-spring projects, oauth2-dom-res-server is waiting for Spring properties that can be injected using multiple means :

- From environment variables
- From notes.ini variables
- Or from a custom osgi plugin

The awaited properties are :

| Property                      | Description                         |
| ---                           | ---                                 |
| oauth2.resource.checkTokenUrl | OAuth2 Token introspection endpoint |
| oauth2.resource.clientId      | OAuth2 client Id                    |
| oauth2.resource.secret        | OAuth2 client secret                |

The token introspection endpoint depends on your Authroization Server.

The clientId and secret are used to authenticate your resource server with the OAuth2 Authorization Server when accessing the introspection endpoint.

# Implementing a new resource (Rest Service)

## Declare a new OAuth2 application

Depending on the Authorization Server, you will have to declare a new OAuth2 application. This should give you the clientId and the secret.

The Authorization Server should also document the token introspection URL.

## Prepare Domino Designer

### Install dom-spring update site

You have to install the dom-spring update site into your Designer. The update site is the same that you installed on your Domino Server :

- Go to File/Preferences menu, in the "Domino Designer" section, and check "Enable Eclipse plug-in install"
- Now, go to File/Application/Install menu.
- Select "Search for new features"
- Add a "Zip/jar location" and go find the zip that correspond to the dom-spring update site (the same file you use to install on your server).
- Click Finish, and accept licences.
- Designer will ask to restart.

### Install oauth2-dom-res-server update site

You have to install the same update site that you deployed on your Domino Server :

- Go to File/Preferences menu, in the "Domino Designer" section, and check "Enable Eclipse plug-in install"
- Now, go to File/Application/Install menu.
- Select "Search for new features"
- Add a "Zip/jar location" and go find the zip that correspond to this project update site (the same file you use to install on your server).
- Click Finish, and accept licences.
- Designer will ask to restart.

## Prepare Eclipse Oxygen

Working with standard Eclipse requires a few more steps.

### Install the XPages SDK

Download the XPages SDK zip file from :

	https://www.openntf.org/main.nsf/project.xsp?r=project/XPages%20SDK%20for%20Eclipse%20RCP

Unzip the file to the folder of your choice. Then, in Eclipse, go to the menu "Help / Install new software".

In the dialog box, click the "add" button in from of the "Work with" combo :

- Name = XPages sdk
- Click the "Folder" button, and go find the folder named "org.openntf.xsp.sdk.updatesite" in the extracted zip file.

Select all features, accept licences, "Install anyway" when prompted to, and restart Eclipse.

### Declare Java Runtime and Target Platform

Open Eclipse preferences, and go to the section "XPages SDK" :

- Enable using IBM DOMINO on this computer
- Enter the path to the notes.ini, the installation folder of your Domino Server, and the path to your data folder.
- Click "Automatically create JRE for domino"
- And "Apply".

This will create a new JRE Runtime, and a new Target platform. Select them :

- Go to the section "Java / Installed JREs", and select the newly created JRE (XPages Domino JRE)
- Go to the section "Plugins Development / Target platform", and select the newly created target platform (Domino Target).

### Install the dom-spring plugins

Once your environment is ready, you can install the update site.

- Menu Help / Install New Software
- Add an update site
- Go find the update site (the zip file) you just downloaded
- Click next, finish, etc... until Eclipse ask to reboot.

### Install the oauth2-dom-res-server plugins

Once your environment is ready, you can install the update site.

- Menu Help / Install New Software
- Add an update site
- Go find the update site (the zip file) you just downloaded
- Click next, finish, etc... until Eclipse ask to reboot.

## Implement the rest service (the oauth2 resource)

Rest services are implemented using Spring Rest, as described in the [Domino Spring Project](http://github.com/lhervier.dom-spring), but with little differences :

- Extend the BaseOauthResourceServlet instead of OsgiDispatcherServlet. This one will only allow requests Ã  the root of the server context.
- Your Spring Configuration class will have to extend the provided "com.lhervier.github.domino.oauth.resource.BaseOauthResourceConfig" class. This will allow you to @Autowired
a bean based on the "com.github.lhervier.domino.oauth.resource.BearerContext" class.

The BearerContext will give you access to :

- The description of the access token by using its getAccessToken() method.
- A Notes Session opened as a user whose name is in the "sub" property of the token. Use the getBearerSession() method to get it.

# The sample resource application

The "sample" folder contains a sample application that declares a simple Rest Service accessible via a bearer token. Once you have deployed the plugin, you can access the following URL :

	http://dominoserver/resource-sample/apis/users?startsWith=X&limit=10
	
You will have to add a HTTP header "Authorization" that contains the "Bearer" keyword followed by your OAUTH2 access token.

The request will answer with a JSON object that reads the users from the ($VIMPeople) view of the names.nsf database (showing that user rights are OK). It will
also return the current user name, and the authorized scopes.

To play with the code, simply import the projects present in the "sample" sub folder into Domino Designer.

# TODO

- Test with Google Cloud (Only tested using oauth2-dom-auth-server)
- Implement decoding tokens as JWTs (to support ADFS)
- Make update site generation work with maven
